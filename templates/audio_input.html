<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Audio Input — Sentiment AI</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root{--glass-bg:rgba(255,255,255,0.18);--card-border:rgba(255,255,255,0.18);--accent:#aa96da}
        body{font-family:'Poppins',sans-serif;background:linear-gradient(135deg,#d4a5a5,#a8d8ea,#aa96da);min-height:100vh;padding-top:5rem}
        .glass-shape{position:absolute;border-radius:50%;background:rgba(255,255,255,0.15);backdrop-filter:blur(12px);border:1px solid var(--card-border);z-index:-1}
        .shape-1{width:260px;height:260px;top:-80px;left:-80px}
        .shape-2{width:360px;height:360px;bottom:-120px;right:-120px}
        .main-container{max-width:820px;margin:0 auto;background:rgba(255,255,255,0.22);backdrop-filter:blur(14px);border-radius:20px;padding:2.25rem;border:1px solid var(--card-border);box-shadow:0 8px 32px rgba(31,38,135,0.37)}
        .result{margin-top:1rem}
        .confidence{font-weight:600}
        /* selector and button styles */
        .btn-group[role="group"]{gap:12px}
        .btn-toggle{padding:.6rem 1.1rem;border-radius:12px;font-weight:600;cursor:pointer;border:1px solid rgba(255,255,255,0.18);background:transparent;color:var(--text-color)}
        /* active state uses orange gradient */
        .btn-toggle.active{color:#fff;background:linear-gradient(90deg,#ff7a00,#ffb347);box-shadow:0 6px 18px rgba(0,0,0,0.12);border:none}
        .gradient-btn{background:linear-gradient(90deg,#ff7a00,#ffb347);color:#fff;border:none;border-radius:10px;padding:.6rem 1rem;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
        /* distinct record button (green) */
        .record-btn{background:linear-gradient(90deg,#28a745,#7be495);color:#fff;border:none;border-radius:10px;padding:.6rem 1rem;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
        /* stop button (red) */
        .stop-btn{background:linear-gradient(90deg,#e65a5a,#f28b82);color:#fff;border:none;border-radius:10px;padding:.6rem 1rem;box-shadow:0 6px 18px rgba(0,0,0,0.12)}
        .gradient-btn:disabled{opacity:.7}
        .choice-area{display:flex;gap:12px;align-items:center}
        .nav-right a{margin-left:1rem}
    </style>
</head>
<body>
<div class="glass-shape shape-1"></div>
<div class="glass-shape shape-2"></div>
    <nav class="navbar" style="position: fixed; top: 0; left:0; right:0; background: var(--glass-bg); backdrop-filter: blur(10px); border-bottom: 1px solid var(--card-border); box-shadow: 0 4px 16px rgba(0,0,0,0.1); padding: 1rem 2rem; z-index:1000;">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <a href="/" class="navbar-brand" style="display:flex;align-items:center;gap:.75rem;font-weight:600;font-size:1.25rem;color:var(--text-color);text-decoration:none;">
                <i class="fas fa-brain" style="color:var(--accent);"></i>
                Sentiment AI
            </a>
            <div class="nav-links" style="display:flex;gap:1rem;">
                <a href="/user_history" class="nav-link">My History</a>
                {% if session.get('role') == 'admin' %}
                <a href="/admin" class="nav-link">Admin Panel</a>
                {% endif %}
                <a href="/logout" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

<div class="container mt-4">
    <div class="main-container">
        <h3>Audio Input</h3>
    <p>Choose an audio input method: <strong>Live Recording</strong> or <strong>Upload File</strong>.</p>

    <div class="btn-group mb-3 choice-area" role="group" aria-label="Audio input choice">
        <button id="chooseLive" type="button" class="btn-toggle">Live Recording</button>
        <button id="chooseFile" type="button" class="btn-toggle">Upload File</button>
    </div>

    <!-- Live recording section -->
    <div id="liveSection" style="display:none;">
        <div class="mb-3">
            <button id="startRecordBtn" class="record-btn"><i class="fas fa-microphone me-2"></i>Start Recording</button>
            <button id="stopRecordBtn" class="stop-btn" disabled><i class="fas fa-stop me-2"></i>Stop Recording</button>
        </div>
        <div id="liveStatus" class="mb-2 text-muted">Not recording.</div>
    </div>

    <!-- File upload section -->
    <div id="fileSection" style="display:none;">
        <input id="audioFile" type="file" accept="audio/*" class="form-control" />
        <div class="d-flex gap-2 mt-3">
            <button id="uploadBtn" class="record-btn"><i class="fas fa-upload me-2"></i>Upload & Analyze</button>
            <a href="/text_input" class="btn btn-outline-light" style="border-radius:10px;padding:.5rem .9rem;color:var(--text-color);background:rgba(255,255,255,0.12);">Use Text Instead</a>
        </div>
    </div>

    <div id="resultArea" class="result" style="display:none;">
        <div class="card">
            <div class="card-body">
                <div id="preAnalysis" style="display:block;">
                    <p><strong>Original (Urdu):</strong></p>
                    <div id="urduText" style="white-space:pre-wrap; background:#fafafa;padding:8px;border-radius:6px;border:1px solid #eee;"></div>

                    <div class="mt-3">
                        <button id="translateBtn" class="btn btn-outline-primary">Translate to English</button>
                        <button id="analyzeBtn" class="btn btn-primary" style="display:none; margin-left:.5rem;">Analyze Text</button>
                    </div>

                    <div id="translatedArea" style="display:none; margin-top:1rem;">
                        <p class="mt-2"><strong>Translated (English):</strong></p>
                        <div id="translatedText" style="white-space:pre-wrap; background:#fafafa;padding:8px;border-radius:6px;border:1px solid #eee;"></div>
                    </div>
                </div>

                <div id="postAnalysis" style="display:none; margin-top:1rem;">
                    <h5 id="prediction" class="card-title"></h5>
                    <p id="confidence" class="confidence"></p>
                    <div id="analysisDetails" style="margin-top:.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="errorBox" class="mt-3 text-danger" style="display:none;"></div>
</div>

    <script>
    // Toggle between Live and File sections
    document.getElementById('chooseLive').addEventListener('click', () => {
        document.getElementById('liveSection').style.display = 'block';
        document.getElementById('fileSection').style.display = 'none';
        document.getElementById('chooseLive').classList.add('active');
        document.getElementById('chooseFile').classList.remove('active');
    });
    document.getElementById('chooseFile').addEventListener('click', () => {
        document.getElementById('liveSection').style.display = 'none';
        document.getElementById('fileSection').style.display = 'block';
        document.getElementById('chooseFile').classList.add('active');
        document.getElementById('chooseLive').classList.remove('active');
    });

    // File upload handler (same as before)
    async function uploadAndAnalyze() {
        const fileInput = document.getElementById('audioFile');
        const errorBox = document.getElementById('errorBox');
        errorBox.style.display = 'none';

        if (!fileInput.files || fileInput.files.length === 0) {
            errorBox.textContent = 'Please select an audio file to upload.';
            errorBox.style.display = 'block';
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        document.getElementById('uploadBtn').disabled = true;
        document.getElementById('uploadBtn').textContent = 'Uploading...';

        try {
            const resp = await fetch('/transcribe', { method: 'POST', body: formData });
            if (!resp.ok) throw new Error('Server error ' + resp.status);
            const data = await resp.json();

            // Show transcription and wait for user to translate/analyze
            showTranscriptionResult(data, true);

        } catch (err) {
            errorBox.textContent = 'Error: ' + err.message;
            errorBox.style.display = 'block';
        } finally {
            document.getElementById('uploadBtn').disabled = false;
            document.getElementById('uploadBtn').innerHTML = '<i class="fas fa-upload me-2"></i>Upload & Analyze';
        }
    }

    document.getElementById('uploadBtn').addEventListener('click', uploadAndAnalyze);

    // Live recording
    let mediaRecorder;
    let audioChunks = [];

    document.getElementById('startRecordBtn').addEventListener('click', async () => {
        const status = document.getElementById('liveStatus');
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];

            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.wav');

                status.textContent = 'Uploading and transcribing...';
                try {
                    const resp = await fetch('/transcribe', { method: 'POST', body: formData });
                    if (!resp.ok) throw new Error('Server error ' + resp.status);
                    const data = await resp.json();
                    // Show transcription and allow translate/analyze
                    showTranscriptionResult(data, true);
                } catch (err) {
                    document.getElementById('errorBox').textContent = 'Error: ' + err.message;
                    document.getElementById('errorBox').style.display = 'block';
                } finally {
                    document.getElementById('stopRecordBtn').disabled = true;
                    document.getElementById('startRecordBtn').disabled = false;
                    status.textContent = 'Not recording.';
                }
            };

            mediaRecorder.start();
            status.textContent = 'Recording...';
            document.getElementById('startRecordBtn').disabled = true;
            document.getElementById('stopRecordBtn').disabled = false;
        } catch (err) {
            document.getElementById('errorBox').textContent = 'Microphone access error: ' + err.message;
            document.getElementById('errorBox').style.display = 'block';
        }
    });

    document.getElementById('stopRecordBtn').addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
    });

    // Store last texts
    let lastUrdu = '';
    let lastEnglish = '';

    function showTranscriptionResult(data, deferAnalysis=false) {
        document.getElementById('resultArea').style.display = 'block';
        // populate urdu and english but don't show analysis unless requested
        lastUrdu = data.urdu_text || '';
        lastEnglish = data.translated_text || '';

        document.getElementById('urduText').textContent = lastUrdu;
        document.getElementById('translatedText').textContent = lastEnglish;

        // Reset UI
        document.getElementById('preAnalysis').style.display = 'block';
        document.getElementById('postAnalysis').style.display = 'none';
        document.getElementById('translatedArea').style.display = 'none';
        document.getElementById('translateBtn').style.display = lastEnglish ? 'inline-block' : 'inline-block';
        document.getElementById('analyzeBtn').style.display = 'none';

        // Attach translate handler
        document.getElementById('translateBtn').onclick = () => {
            document.getElementById('translatedArea').style.display = 'block';
            document.getElementById('analyzeBtn').style.display = 'inline-block';
        };

        // Attach analyze handler
        document.getElementById('analyzeBtn').onclick = async () => {
            const payload = { text: lastEnglish || lastUrdu, original_urdu: lastUrdu };
            try {
                const resp = await fetch('/analyze_text', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!resp.ok) throw new Error('Server error ' + resp.status);
                const result = await resp.json();

                // Show analysis results
                document.getElementById('preAnalysis').style.display = 'none';
                document.getElementById('postAnalysis').style.display = 'block';
                document.getElementById('prediction').textContent = 'Prediction: ' + result.prediction;
                document.getElementById('confidence').innerHTML =
                    'Non-suicidal: ' + (result.confidence[0]*100).toFixed(2) + '% — Suicidal: ' + (result.confidence[1]*100).toFixed(2) + '%';

                let details = '';
                if (result.analysis) {
                    details += '<p><strong>Words:</strong> ' + result.analysis.word_count + '</p>';
                    details += '<p><strong>Text length:</strong> ' + result.analysis.text_length + '</p>';
                    details += '<p><strong>First-person count:</strong> ' + result.analysis.first_person_count + '</p>';
                    if (result.analysis.indicators && result.analysis.indicators.length) {
                        details += '<p><strong>Indicators:</strong> ' + result.analysis.indicators.join(', ') + '</p>';
                    }
                }
                document.getElementById('analysisDetails').innerHTML = details;
            } catch (err) {
                document.getElementById('errorBox').textContent = 'Error analyzing text: ' + err.message;
                document.getElementById('errorBox').style.display = 'block';
            }
        };
    }
    </script>

</body>
</html>